{%- assign section_name = 'product-recommendations' -%}
{% assign section_id = section_name | append: '--' | append: section.id %}

{% assign colour_theme = section.settings.colour_theme | default: 'light' %}
{% assign glider_id = section_id | append: '--glider' %}
{% assign heading = section.settings.heading | default: '' %}
{% assign heading_highlight = section.settings.heading_highlight | default: false %}
{% assign is_glider = false %}

{% if recommendations.products_count > 3 %}
  {% assign is_glider = true %}
{% endif %}

<div class="{{ section_name }}" id="{{ section_id }}" data-url="{{ routes.product_recommendations_url }}?section_id={{ section.id }}&product_id={{ product.id }}&limit=6" data-colour-theme-{{ colour_theme }} data-section-padding>
  {%- if recommendations.performed and recommendations.products_count > 0 -%}

    <div class="{{ section_name }}__intro intro" data-text-alignment-left>
      {% render 'bs-container', state: 'open' %}
        {%
          render 'heading-highlight',
          classes: 'product-recommendations__heading intro__heading heading--2',
          heading: heading,
          style: heading_highlight,
          tag: 'h2'
        %}
      {% render 'bs-container', state: 'closed' %}
    </div>

    <div class="{{ section_name }}__main main{% if is_glider %} with-glider{% endif %}">
      {% if is_glider %}<div class="glide js--glider" id="{{ glider_id }}" data-glide-style="{{ section_name }}">{% endif %}
        {% if is_glider %}<div class="glide__track" data-glide-el="track">{% endif %}
          {% if is_glider %}<ul class="glide__slides">{% endif %}

            {%- for product in recommendations.products -%}
              {% if is_glider %}<li class="glide__slide">{% endif %}
                <div class="{{ section_name }}__item">
                  {% render 'card-product', product: product, style: section_name %}
                </div>
              {% if is_glider %}</li>{% endif %}
            {%- endfor -%}

          {% if is_glider %}</ul>{% endif %}
        {% if is_glider %}</div>{% endif %}
      {% if is_glider %}</div>{% endif %}
    </div>

    {% if is_glider %}
      <div class="glide__controls--technical">
        <button class="glide__button button prev" data-target="#{{ glider_id }}">
          <span class="button__icon">{% render 'svg', type: 'icon.arrow' %}</span>
        </button>
        <button class="glide__button button next" data-target="#{{ glider_id }}">
          <span class="button__icon">{% render 'svg', type: 'icon.arrow' %}</span>
        </button>
      </div>
    {% endif %}

  {%- endif -%}
</div>
{% javascript %}
  const handleIntersection = (entries, observer) => {
    if (!entries[0].isIntersecting) return;

    observer.unobserve(productRecommendationsSection);

    const url = productRecommendationsSection.dataset.url;

    fetch(url)
      .then(response => {
        response.text()
        console.log( response );
      })
      .then(text => {
        const html = document.createElement('div');
        html.innerHTML = text;
        const recommendations = html.querySelector('.product-recommendations');
        if (recommendations && recommendations.innerHTML.trim().length) {
          productRecommendationsSection.innerHTML = recommendations.innerHTML;
        }
      })
      .catch(e => {
        console.error(e);
      });
  };

  const productRecommendationsSection = document.querySelector('.product-recommendations');
  const observer = new IntersectionObserver(handleIntersection, {rootMargin: '0px 0px 200px 0px'});

  observer.observe(productRecommendationsSection);
{% endjavascript %}

{% schema %}
  {
    "name": "Product recommendations",
    "class": "section section--product-recommendations",
    "settings": [
      {
        "content": "Content",
        "type": "header"
      },
      {
        "label": "Heading",
        "type": "richtext",
        "id": "heading"
      },
      {
        "label": "Heading Highlight",
        "type": "select",
        "options": [
          { "value": "standard", "label": "Standard" },
          { "value": "stroke", "label": "Stroke" },
          { "value": "circle", "label": "Circle" }
        ],
        "default": "standard",
        "id": "heading_highlight"
      },
      {
        "content": "Settings",
        "type": "header"
      },
      {
        "label": "Colour Theme",
        "type": "select",
        "options": [
          { "value": "light", "label": "Light" },
          { "value": "grey", "label": "Grey" },
          { "value": "dark", "label": "Dark" }
        ],
        "default": "light",
        "id": "colour_theme"
      }
    ],
    "presets": [
      {
        "name": "Product recommendations"
      }
    ],
    "templates": [ "product" ]
  }
{% endschema %}
